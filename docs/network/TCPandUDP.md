# TCP 和 UDP
TCP和UDP是传输层很重要的了两个协议，主要用于两节点之间数据的传输。  
## TCP  
TCP全称为传输控制协议，是一个面向连接的，可靠的，基于字节流的协议。  
特点：  
* 面向连接。面向连接是指两节点要经过三次握手连接后才能传输数据。  
* 可靠。可靠是指TCP协议会确保数据传输的完整，如果有丢失则会重发。  
* 流量控制。解决当接收端缓存区已满无法处理更多数据，而发送端还在继续发送，造成丢包的问题。    
    1.`RTT算法`（Round Trip Time 环回时间：一个数据包发出到回来的时间）。  
    2.`滑动窗口`。  
    当发送端发送数据给接收端时，接收端回复确认消息时会包含接收窗口(rwnd)大小，如果是剩余大小为0，发送端则停止发送，直到接收端处理完数据，剩余空间大于0，就通知发送端可以继续发送，为了避免接收端发送的通知丢失，发送端无法确认是否能继续发送的情况发生，发送端会每隔一段时间去询问接收端是否窗口大于0，如果是则继续发送，否则继续等待。滑动窗口最大为`min(rwnd, cwnd)`。
* 拥塞控制。当网络发生拥塞时，TCP会减少网络传输数据的速度和数量，缓解阻塞。  
    1.慢启动、拥塞避免。  
    这两种方法是在拥塞发生之前，增加拥塞窗口(cwnd)大小。  
    `慢启动`算法是从小到大增加拥塞窗口大小去探测网络拥塞程度,呈指数增长，速度快。  
    算法核心:初始为1，每收到一个ACK则cwnd++，每经过一个RTT则cwnd=cwnd*2,当cwnd >= ssthresh时（通常ssthresh = 65535），进入拥塞避免算法。  
    `拥塞避免`算法呈线性增长，速度慢，在不造成拥塞的情况下，找到cwnd的最优值。  
    算法核心：每收到一个ACK,则cwnd=cwnd+1/cwnd(cwnd>1时无增长)，每经过一个RTT则cwnd++  

    2.快重传、快恢复。  
    这两种是拥塞发生时的处理及恢复的处理，当发送端发现发送包失败了，就认为网络阻塞了。  
    丢包后，有两种重传方式：  
        1.超时重传。  
        算法核心：ssthresh = cwnd/2, cwnd = 1,重新进入慢启动。  
        2.快速重传。  
        算法核心：ssthresh = cwnd/2, cwnd = cwnd/2,进入拥塞避免算法。  

    `快重传`是当接收端收到乱序的数据包时，会重复回复上一个包的确认信息，如果发送端连续收到三条重复的确认信息，则立即重发丢失的包。例如，发送端发送M1，接收端回复确认M1，若此时发送端发送M2丢失了，发送端再发送M3，M4，M5，接收端都是重复确认M1，发送端就会重发M2。  
    `快恢复`是指当发送端收到三条重复信息时将ssthresh值减半，将cwnd设置为新的ssthresh的值，执行拥塞避免算法。  

### 三次握手  
TCP连接需要经历三次握手：  
1. 客户端发送连接请求给服务端  
2. 服务端接收到后发送确认信息给客户端  
3. 客户端接收后再发送报文给服务端建立连接  

提问，两次握手可以吗？  
不行，因为TCP三次握手也是为了确认客户端与服务器的发送能力和接收能力正常，第一次握手证明了客户端发送能力正常，第二次握手证明服务端的接收和发送能力正常，第三次握手是为了证明客户端接收能力正常。少了任意一环都无法确认。  

提问，握手过程中可以携带数据吗？  
第三次握手的时候可以，因为第三次握手时客户端已经处于建立连接状态，服务端的接收及发送能力也是正常状态。第一次和第二次不行，因为可能会让服务器受到攻击。


### 四次挥手  
TCP关闭连接需要进行四次挥手：  
1. 客户端发送关闭连接的请求给服务端  
2. 服务端回复确认消息给客户端  
3. 服务端发送完数据后，回复给客户端关闭连接的消息  
4. 客户端收到后发送关闭消息给服务端，并在等待2MSL后关闭连接  

提问，为什么需要四次挥手？  
因为客户端发送关闭请求时服务端有可能还有数据没有发送完，所以会先告诉客户端收到关闭请求了，但是需要先把所有数据发送完，才会回复客户端可以关闭连接了。  

提问，为什么客户端要等待2MSL再断开连接？  
为了防止报文丢失，服务端无法收到客户端要断开连接的消息。MSL是指一个报文段的最大生存时间，如果发送的报文丢失，服务端确认超时及请求重发最大需要2MSL。   

## UDP  
UDP全称为用户数据报文协议。是一种无连接的，不可靠的协议。  
特点：  
* 无连接。UDP在发送数据前无需进行三次握手连接，可以直接发送，且不会对数据报文进行任何拆分、拼接处理。  
* 不可靠性。发送数据时不会关心对方是否有收到，且没有流量控制和拥塞控制，当网络不好时，很容易造成丢包的情况。在实时性要求高，比如直播、视频会议等情况下，具有优势。   

## 对比  
|                 |TCP                      |UDP               |
|-----------------|-------------------------|------------------|
|是否连接          |是                       |否                |
|是否可靠          |可靠                     |不可靠               |
|连接对象个数      |一对一                |一对一、一对多、多对一、多对多|
|传输方式          |面向字节流                |面向报文           |
|首部开销          |最小20字节，最大60字节   |只有8字节，传输报文更高效|
|使用场景          |文件传输等可靠传输        |实时性要求高的场景     |  

