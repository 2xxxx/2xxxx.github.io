<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>vue | 学习笔记</title>
    <meta name="generator" content="VuePress 1.5.3">
    
    <meta name="description" content="xcc的备忘笔记">
    <link rel="preload" href="/assets/css/0.styles.abfd12c2.css" as="style"><link rel="preload" href="/assets/js/app.34fc8ccb.js" as="script"><link rel="preload" href="/assets/js/2.f6cac430.js" as="script"><link rel="preload" href="/assets/js/15.68d21866.js" as="script"><link rel="prefetch" href="/assets/js/10.9e350fd5.js"><link rel="prefetch" href="/assets/js/11.3e7f150a.js"><link rel="prefetch" href="/assets/js/12.246acfd5.js"><link rel="prefetch" href="/assets/js/13.dc65eca0.js"><link rel="prefetch" href="/assets/js/14.d1564ab1.js"><link rel="prefetch" href="/assets/js/16.0247a9c7.js"><link rel="prefetch" href="/assets/js/17.5080048a.js"><link rel="prefetch" href="/assets/js/18.e824ab33.js"><link rel="prefetch" href="/assets/js/19.6dcea4f4.js"><link rel="prefetch" href="/assets/js/20.2df51597.js"><link rel="prefetch" href="/assets/js/21.6fa8143d.js"><link rel="prefetch" href="/assets/js/22.07ecf39d.js"><link rel="prefetch" href="/assets/js/23.1beb4da4.js"><link rel="prefetch" href="/assets/js/24.90c12f39.js"><link rel="prefetch" href="/assets/js/25.31ff9110.js"><link rel="prefetch" href="/assets/js/26.cc5fb724.js"><link rel="prefetch" href="/assets/js/27.b43bef45.js"><link rel="prefetch" href="/assets/js/28.e9bb89fb.js"><link rel="prefetch" href="/assets/js/29.3d99059a.js"><link rel="prefetch" href="/assets/js/3.a51774e3.js"><link rel="prefetch" href="/assets/js/30.81860bc5.js"><link rel="prefetch" href="/assets/js/4.3b6a7e49.js"><link rel="prefetch" href="/assets/js/5.bc6e1aa4.js"><link rel="prefetch" href="/assets/js/6.569a4170.js"><link rel="prefetch" href="/assets/js/7.6d77f350.js"><link rel="prefetch" href="/assets/js/8.409c27ea.js"><link rel="prefetch" href="/assets/js/9.50a845cf.js">
    <link rel="stylesheet" href="/assets/css/0.styles.abfd12c2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">学习笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/front/" class="nav-link">
  笔记
</a></div><div class="nav-item"><a href="https://github.com/2xxxx" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/front/" class="nav-link">
  笔记
</a></div><div class="nav-item"><a href="https://github.com/2xxxx" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>浏览器基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>网络基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>项目和业务</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>前端框架</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/frame/" aria-current="page" class="sidebar-link">框架架构</a></li><li><a href="/frame/vue.html" aria-current="page" class="active sidebar-link">vue</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/frame/vue.html#vue的生命周期" class="sidebar-link">vue的生命周期</a></li><li class="sidebar-sub-header"><a href="/frame/vue.html#双向绑定" class="sidebar-link">双向绑定</a></li><li class="sidebar-sub-header"><a href="/frame/vue.html#vue组件通信" class="sidebar-link">vue组件通信</a></li><li class="sidebar-sub-header"><a href="/frame/vue.html#vue-router" class="sidebar-link">vue-router</a></li><li class="sidebar-sub-header"><a href="/frame/vue.html#虚拟dom" class="sidebar-link">虚拟dom</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/frame/vue.html#diff" class="sidebar-link">diff</a></li></ul></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="vue"><a href="#vue" class="header-anchor">#</a> vue</h1> <p>vue是一个mvvm结构的框架。核心思想主要是组件化和数据驱动。<br>
优点：从复杂的dom操作中解放出来，由数据变化驱动页面视图更改，只要关心要显示操作哪些数据，要如何显示。</p> <p>使用vue都要有一个vue 的根实例，vue的实例对象是其data属性值的代理。根的data属性是一个对象，组件内的data属性是函数。</p> <p>提问，为什么组件中data是函数？对象是引用类型，当复用组件时，由于数据对象指向同一个data,一个组件修改data会造成其他复用组件的data同时修改，使用函数的话，每次都会返回不同的对象。</p> <h2 id="vue的生命周期"><a href="#vue的生命周期" class="header-anchor">#</a> vue的生命周期</h2> <p>总共8个，<br>
创建前后(beforeCreate,created)：el和data都为初始化、<br>
挂载前后(beforeMount,mounted)： data有初始化,el没有、<br>
更新前后(beforeUpdate,updated)： 前（完成了el和data初始化，挂载虚拟dom），后（完成挂载，渲染），、<br>
销毁前后(beforeDestroy,destroyed)</p> <h2 id="双向绑定"><a href="#双向绑定" class="header-anchor">#</a> 双向绑定</h2> <p>原理: 采用数据劫持结合发布者-订阅者模式的方式，通过Object.defineProperty()来劫持各个属性的setter和getter,在数据变动是发布消息给订阅者，触发相应的监听回调。</p> <p>流程：</p> <ol><li>实现一个数据监听器Observer,能够对数据所有属性进行监听，如有变动可拿到最新值并且通知订阅者。</li> <li>实现一个指令解析器Compile,对每个元素节点的指令进行扫描和解析，根据指令模板替换数据，以及绑定相应的更新函数。</li> <li>实现一个Watcher，作为连接Observer和Compile的桥梁，能订阅并收到每个属性变动的通知，执行指令绑定的相应回调函数，从而更新视图。</li> <li>mvvm入口函数，整合以上三者。
具体方法：</li> <li>getAttribute获取属性，正则收集指令</li> <li>指令添加处理函数</li> <li>data内的对象用defineProperty监听，在变化时进行拦截。</li> <li>检测到数据变化后更新对应的DOM节点</li></ol> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>text<span class="token punctuation">'</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>str<span class="token punctuation">'</span></span> <span class="token attr-name">onkeyup</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>func()<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>spans<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>{{text.name}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>   

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token punctuation">{</span>
        name<span class="token operator">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> subs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">observe</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token comment">// function func() {</span>
    <span class="token comment">//     let str = document.getElementById('str').value;  </span>
    <span class="token comment">//     text.name = str;</span>

    <span class="token comment">// }  </span>
    <span class="token comment">// function fun1() {</span>
    <span class="token comment">//     let spannode = document.getElementById('spans');</span>
    <span class="token comment">//     spannode.innerText = text.name </span>
    <span class="token comment">// }</span>
    <span class="token keyword">function</span> <span class="token function">observe</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>data <span class="token operator">||</span> <span class="token keyword">typeof</span> data <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token keyword">return</span>  
        <span class="token comment">//取出所有属性遍历</span>
        Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">definekey</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> data<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">definekey</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> key<span class="token punctuation">,</span> val</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">var</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">observe</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//监听子属性</span>
        Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span>key<span class="token punctuation">,</span> <span class="token punctuation">{</span>
            enumerable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//可枚举</span>
            configurable<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>  <span class="token comment">//不能再define</span>
            <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> val
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">newval</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>val <span class="token operator">===</span> newval<span class="token punctuation">)</span> <span class="token keyword">return</span>
                val <span class="token operator">=</span> newval<span class="token punctuation">;</span>
                dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">//通知所有订阅者</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>  
    <span class="token keyword">function</span> <span class="token function">Dep</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        subs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Dep</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">addSub</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">sub</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            subs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function-variable function">notify</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            subs<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">sub</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                sun<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    data<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="vue组件通信"><a href="#vue组件通信" class="header-anchor">#</a> vue组件通信</h2> <ol><li><p><strong>props/$emit</strong>
父组件A通过props向子组件B传递，子组件向父组件通过子组件中的$emit，父组件中的v-on实现</p></li> <li><p><strong>$emit/$on</strong>
通过一个空的Vue实例作为中央事件总线来触发事件和监听事件，可以实现任意组件间的通信。</p></li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> ebus <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ebus<span class="token punctuation">.</span><span class="token function">$emit</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token operator">...</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
ebus<span class="token punctuation">.</span><span class="token function">$on</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> cb<span class="token punctuation">)</span><span class="token punctuation">;</span>
ebus<span class="token punctuation">.</span><span class="token function">$off</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> cb<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//在组件销毁是可取消响应，以免冲突</span>
</code></pre></div><ol start="3"><li><strong>Vuex</strong><br>
是vue的状态管理器，Vuex实现了一个单向数据流，在全局拥有一个State存放数据，当组件要更改State中数据时，必须通过Mutation(commit，同步)修改，异步操作或者批量同步操作则使用Action(dispatch),但Action也是通过Mutation修改State中的数据。最后根据state数据渲染到视图上。getters是State对象的读取方法。<br>
Vuex存储的数据是响应式的，但是不会保存起来，刷新页面后就会回到初始状态，要想刷新后保存，需要存储在localStorage中（只支持字符串，需要JSON转换）。</li></ol> <p>4.<strong>$parent/$children与ref</strong><br>
ref: 在普通DOM上使用，引用指向的就是DOM元素，在子组件上使用，就是指向组件实例。<br>
$parent/$children: 访问父/子实例</p> <p>还有其他通信方法，不常用就没列举。</p> <h2 id="vue-router"><a href="#vue-router" class="header-anchor">#</a> vue-router</h2> <p>hash和history模式的区别:<br>
vue默认hash模式，url改变时页面不会重新加载</p> <p>hash模式是通过改变锚点(#)来更新页面URL，并不会触发页面重新加载，我们可以通过window.onhashchange监听到hash的改变，从而处理路由。
history模式是通过调用window.history对象上的一系列方法来实现页面的无刷新跳转</p> <h2 id="虚拟dom"><a href="#虚拟dom" class="header-anchor">#</a> 虚拟dom</h2> <p>虚拟dom是根据真实dom提炼出的简单树状对象，将真实dom中的属性简化如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
    tag<span class="token operator">:</span> <span class="token string">'div'</span><span class="token punctuation">,</span>  <span class="token comment">//标签名  </span>
    data<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>   <span class="token comment">//属性数据，包括class,style,event,props,attrs等  </span>
    children<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">//子节点数组，也是vnode结构  </span>
    text<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token comment">//文本</span>
    elm<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>  <span class="token comment">//真实dom,旧的Vnode指向真实的node,新的Vnode指向undefined</span>
    key<span class="token operator">:</span> <span class="token keyword">undefined</span>  <span class="token comment">//节点标识</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Vue是由数据驱动视图，当某个数据修改时，视图在修改部分进行局部刷新。想要精准的找到视图就需要拿到数据改变前后的dom结构，找到差异并更新。</p> <h3 id="diff"><a href="#diff" class="header-anchor">#</a> diff</h3> <p>diff实现主要通过两个方法：patchVnode和updateChildren。</p> <p>虚拟dom比较：将新节点和旧节点做比较，对差异打补丁(patchVnode)。节点比较时，如果不相似则新建一个节点，如过相似则先对比节点data属性里的字段，有不同的就调用update函数进行更新，再是对子节点进行比较,如果在比较过程中找到了相似的childVnode,则递归进入新的打补丁的过程。</p> <p>源码实现：</p> <div class="language-js extra-class"><pre class="language-js"><code>   <span class="token keyword">function</span> <span class="token function">patch</span><span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token punctuation">,</span> vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token keyword">var</span> elm<span class="token punctuation">,</span>parent<span class="token punctuation">;</span>
       <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">sameVnode</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span>vnode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token comment">//若相似就打补丁   </span>
           <span class="token function">patchVnode</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span>vnode<span class="token punctuation">)</span>
       <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
           <span class="token comment">//不相似，直接覆盖  </span>
           elm <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>elm<span class="token punctuation">;</span>  
           parent <span class="token operator">=</span> api<span class="token punctuation">.</span><span class="token function">parentNode</span><span class="token punctuation">(</span>elm<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token function">createElm</span><span class="token punctuation">(</span>vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>  
           <span class="token keyword">if</span><span class="token punctuation">(</span>parent <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               api<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> elm<span class="token punctuation">,</span> api<span class="token punctuation">.</span><span class="token function">nextSibling</span><span class="token punctuation">(</span>elm<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
               <span class="token function">removeVnodes</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span><span class="token punctuation">[</span>oldVnode<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0</span> <span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">return</span> vnode<span class="token punctuation">.</span>elm<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>  

   <span class="token keyword">function</span> <span class="token function">sameVnode</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span>b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">//判断新旧vnode，比较tag和key是否一致</span>
       <span class="token keyword">return</span> a<span class="token punctuation">.</span>key <span class="token operator">===</span> b<span class="token punctuation">.</span>key <span class="token operator">&amp;&amp;</span> a<span class="token punctuation">.</span>tag <span class="token operator">===</span> b<span class="token punctuation">.</span>tag<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>  

   <span class="token comment">//打补丁</span>
   <span class="token keyword">function</span> <span class="token function">patchVnode</span><span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token punctuation">,</span> vnode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">//新节点引用旧节点的dom  </span>
       <span class="token keyword">let</span> elm <span class="token operator">=</span> vnode<span class="token punctuation">.</span>elm <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>elm<span class="token punctuation">;</span>
       <span class="token keyword">const</span> oldCh <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>children<span class="token punctuation">;</span>  
       <span class="token keyword">const</span> ch <span class="token operator">=</span> vnode<span class="token punctuation">.</span>children<span class="token punctuation">;</span>

       <span class="token comment">//调用update钩子,打补丁就是调用update函数，更新真实dom的属性  </span>
       <span class="token keyword">if</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token function">updateAttrs</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token function">updateClass</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token function">updateEventListener</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token function">updateProps</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token function">updateStyle</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">,</span> vnode<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>

       <span class="token comment">//update函数实例  </span>
       <span class="token keyword">function</span> <span class="token function">updateAttrs</span><span class="token punctuation">(</span><span class="token parameter">oldVnode<span class="token punctuation">,</span> vnode</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
           <span class="token keyword">let</span> key<span class="token punctuation">,</span>cur<span class="token punctuation">,</span>old
           <span class="token keyword">const</span> oldAttrs <span class="token operator">=</span> oldVnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>attrs <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
           <span class="token keyword">const</span> attrs <span class="token operator">=</span> vnode<span class="token punctuation">.</span>data<span class="token punctuation">.</span>attrs <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

           <span class="token comment">//更新/添加属性 . 遍历vnode属性，如果和oldVnode不一样就调用setAttribute;</span>
           <span class="token keyword">for</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> attrs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               cur <span class="token operator">=</span> attrs<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
               old <span class="token operator">=</span> oldAttrs<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
               <span class="token keyword">if</span><span class="token punctuation">(</span>old <span class="token operator">!==</span> cur<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                   <span class="token keyword">if</span><span class="token punctuation">(</span>booleanAttrsDict<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> cur <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                       <span class="token comment">//判断是否在布尔类型的属性字典中，例如async,autoplay,checked,autofocus等需要先移除该属性。</span>
                       elm<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                   <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                       <span class="token comment">//新增，更新</span>
                       elm<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> cur<span class="token punctuation">)</span>
                   <span class="token punctuation">}</span>
               <span class="token punctuation">}</span> 
           <span class="token punctuation">}</span>

           <span class="token comment">//删除新节点不存在的属性. 遍历oldVnode属性，如果不在vnode属性中就调用removeAttribute删除</span>
           <span class="token keyword">for</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> oldAttrs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> attrs<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                   elm<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
               <span class="token punctuation">}</span>
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>

       <span class="token comment">//判断是否为文本节点 ，如果是就不考虑子节点的比较</span>
       <span class="token keyword">if</span><span class="token punctuation">(</span>vnode<span class="token punctuation">.</span>text <span class="token operator">==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token comment">//如果不是：</span>
            
           
           <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isDef</span><span class="token punctuation">(</span>Ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// 1.新旧节点都有children,那就进入子节点比较(diff);</span>
              <span class="token keyword">if</span><span class="token punctuation">(</span>oldCn <span class="token operator">!==</span> ch<span class="token punctuation">)</span> <span class="token function">updateChildren</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span> ch<span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>
           <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token comment">//2.新节点有children，旧节点没有，那就循环创建dom节点  </span>
               <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> api<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token function">addVnodes</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> ch<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ch<span class="token punctuation">.</span>length <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> insertedVnodeQueue<span class="token punctuation">)</span>
           <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldCh<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token comment">//3.新节点没有children,旧节点有，就循环删除dom节点 </span>
               <span class="token function">removeVnodes</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> oldCh<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span> oldCh<span class="token punctuation">.</span>length <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> 
           <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isDef</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               api<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
           <span class="token punctuation">}</span>
       <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>oldVnode<span class="token punctuation">.</span>text <span class="token operator">!==</span> vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           api<span class="token punctuation">.</span><span class="token function">setTextContent</span><span class="token punctuation">(</span>elm<span class="token punctuation">,</span> vnode<span class="token punctuation">.</span>text<span class="token punctuation">)</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">9/21/2020, 9:55:36 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/frame/" class="prev router-link-active">
        框架架构
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.34fc8ccb.js" defer></script><script src="/assets/js/2.f6cac430.js" defer></script><script src="/assets/js/15.68d21866.js" defer></script>
  </body>
</html>
