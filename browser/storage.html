<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>缓存与存储 | 学习笔记</title>
    <meta name="generator" content="VuePress 1.5.3">
    
    <meta name="description" content="xcc的备忘笔记">
    <link rel="preload" href="/assets/css/0.styles.abfd12c2.css" as="style"><link rel="preload" href="/assets/js/app.bd3a774d.js" as="script"><link rel="preload" href="/assets/js/2.591daaf2.js" as="script"><link rel="preload" href="/assets/js/13.568dcd97.js" as="script"><link rel="prefetch" href="/assets/js/10.3cb190c7.js"><link rel="prefetch" href="/assets/js/11.97d19dd3.js"><link rel="prefetch" href="/assets/js/12.807525a5.js"><link rel="prefetch" href="/assets/js/14.f361b042.js"><link rel="prefetch" href="/assets/js/15.fa8dcc41.js"><link rel="prefetch" href="/assets/js/16.d66bb3a4.js"><link rel="prefetch" href="/assets/js/17.c78ff984.js"><link rel="prefetch" href="/assets/js/18.31a74e1e.js"><link rel="prefetch" href="/assets/js/19.f99ab3fa.js"><link rel="prefetch" href="/assets/js/20.2cf38dce.js"><link rel="prefetch" href="/assets/js/21.afa2a950.js"><link rel="prefetch" href="/assets/js/22.ea1f3d58.js"><link rel="prefetch" href="/assets/js/23.1db48f7d.js"><link rel="prefetch" href="/assets/js/24.e82ba836.js"><link rel="prefetch" href="/assets/js/25.19af2c64.js"><link rel="prefetch" href="/assets/js/26.5b4e9966.js"><link rel="prefetch" href="/assets/js/27.ada649c4.js"><link rel="prefetch" href="/assets/js/28.81d1b5f0.js"><link rel="prefetch" href="/assets/js/29.a3f2fcef.js"><link rel="prefetch" href="/assets/js/3.05ec25a4.js"><link rel="prefetch" href="/assets/js/30.5b460bc7.js"><link rel="prefetch" href="/assets/js/31.51a84dc3.js"><link rel="prefetch" href="/assets/js/32.a823fa56.js"><link rel="prefetch" href="/assets/js/33.0a9df6f4.js"><link rel="prefetch" href="/assets/js/34.d19a0778.js"><link rel="prefetch" href="/assets/js/35.e4573d08.js"><link rel="prefetch" href="/assets/js/36.de6e2c3e.js"><link rel="prefetch" href="/assets/js/37.2487197e.js"><link rel="prefetch" href="/assets/js/38.120497d7.js"><link rel="prefetch" href="/assets/js/4.3b6a7e49.js"><link rel="prefetch" href="/assets/js/5.bc6e1aa4.js"><link rel="prefetch" href="/assets/js/6.29dc4fad.js"><link rel="prefetch" href="/assets/js/7.ea924bc2.js"><link rel="prefetch" href="/assets/js/8.ccecbc63.js"><link rel="prefetch" href="/assets/js/9.e583fadd.js">
    <link rel="stylesheet" href="/assets/css/0.styles.abfd12c2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">学习笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/front/" class="nav-link">
  笔记
</a></div><div class="nav-item"><a href="https://github.com/2xxxx" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="/front/" class="nav-link">
  笔记
</a></div><div class="nav-item"><a href="https://github.com/2xxxx" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>浏览器基础</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/browser/" aria-current="page" class="sidebar-link">浏览器</a></li><li><a href="/browser/event.html" class="sidebar-link">事件</a></li><li><a href="/browser/crossDomain.html" class="sidebar-link">跨域</a></li><li><a href="/browser/storage.html" aria-current="page" class="active sidebar-link">缓存与存储</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/browser/storage.html#浏览器缓存" class="sidebar-link">浏览器缓存</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/browser/storage.html#强缓存" class="sidebar-link">强缓存</a></li><li class="sidebar-sub-header"><a href="/browser/storage.html#协商缓存" class="sidebar-link">协商缓存</a></li></ul></li><li class="sidebar-sub-header"><a href="/browser/storage.html#浏览器存储" class="sidebar-link">浏览器存储</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/browser/storage.html#cookie" class="sidebar-link">cookie</a></li><li class="sidebar-sub-header"><a href="/browser/storage.html#localstorage-和-sessionstorage" class="sidebar-link">localStorage 和 sessionStorage</a></li><li class="sidebar-sub-header"><a href="/browser/storage.html#indexeddb" class="sidebar-link">IndexedDB</a></li></ul></li></ul></li><li><a href="/browser/render.html" class="sidebar-link">浏览器渲染</a></li><li><a href="/browser/eventLoop.html" class="sidebar-link">Event Loop</a></li><li><a href="/browser/safety.html" class="sidebar-link">前端安全</a></li><li><a href="/browser/recycle.html" class="sidebar-link">垃圾回收机制</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>网络基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>项目和业务</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端框架</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据结构</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>html和css</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>编程</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="缓存与存储"><a href="#缓存与存储" class="header-anchor">#</a> 缓存与存储</h1> <h2 id="浏览器缓存"><a href="#浏览器缓存" class="header-anchor">#</a> 浏览器缓存</h2> <p>缓存机制：客户端发送请求时先发给浏览器缓存，如果有缓存数据且生效，则返回200 from Cache（现在已区分disk和memory）和缓存数据，如果失效则携带缓存标识向服务器去请求，由服务器决定是否启用缓存，若启用则协商缓存生效返回304，客户端使用浏览器缓存资源，若缓存失效，服务器返回200和新数据，并将该数据及缓存规则标识存在浏览器缓存中.</p> <p>缓存作用：</p> <ul><li>减少网络带宽消耗</li> <li>减少服务器压力</li> <li>减少网络延迟，提升用户体验</li></ul> <h3 id="强缓存"><a href="#强缓存" class="header-anchor">#</a> 强缓存</h3> <p>强缓存就是向浏览器缓存查询请求结果，并根据回复结果的缓存规则判断是否要使用缓存的过程。</p> <p><strong>强缓存控制字段</strong><br>
http1.0使用的是<code>Expires</code>,http1.1使用的<code>Cache-Control</code>.</p> <p><code>Expires</code>：响应头字段，值为服务器返回的请求结果到期时间，控制原理是将客户端时间与服务端返回的时间做对比，如果用户修改了本地时间，或时区不同发生误差，会导致缓存失效。</p> <p><code>Cache-Control</code>: 取值</p> <ul><li>public: 所有的内容都缓存(客户端和服务器)</li> <li>private： 所有内容都缓存(客户端)，默认取值</li> <li>no-cache：客户端缓存内容，但是是否使用由协商缓存决定</li> <li>no-store：所有内容都不会被缓存</li> <li>max-age：max-age = xxx,缓存内容会在xxx秒后失效。当值=0时，会先查看资源是否有修改(检验协商缓存是否生效)，与no-cache类似</li></ul> <p><strong>优先级</strong><br>
两个字段同时存在时Cache-Control优先级更高。Expires主要是为了向下兼容。</p> <h3 id="协商缓存"><a href="#协商缓存" class="header-anchor">#</a> 协商缓存</h3> <p>强制缓存失效后，客户端携带缓存标志向服务端发出http请求，由服务端决定是否启用缓存，协商缓存生效返回304，协商缓存失败返回200。</p> <p><strong>协商缓存控制字段</strong><br>
HTTP1.0使用<code>Last-Modified</code> 和 <code>If-Modified-Since</code>,HTTP1.1使用的<code>Etag</code> 和 <code>If-None-Match</code>.</p> <p><code>Last-Modified</code>：是服务端响应请求时，返回的该资源在服务器最后修改的时间。<br>
流程：</p> <ol><li>客户端首次请求，服务器会在响应头带上Last-Modified,并告知缓存到期时间</li> <li>客户端请求时会在请求头携带If-Modified-Since,值为上次响应回复的Last-Modifoed</li> <li>服务器收到后会对比最新的修改时间是否大于If-Modified-Since,如果大于就返回资源，状态为200，并更新Last-Modified,否则回复304，代表资源无更新。</li></ol> <p><code>Etag</code>: 是由服务器生成的资源文件的唯一标识。<br>
流程：</p> <ol><li>客户端首次请求，服务响应时会在响应头携带Etag标识</li> <li>客户端在发送请求时会在请求头携带If-None-Match，值为上次返回的Etag</li> <li>服务器接收后会判断If-None-Match的值是否与最新的Etag相等，若不相等则表明资源文件已修改，服务器返回200和最新资源，若相等则返回304.</li></ol> <p><strong>优先级</strong><br>
两个字段同时存在时Etag优先级更高，因为Last-Modified只能作用于秒级的改变，若是1秒改变N次则无法判断，Etag判断更加准确，Etag由响应头的Last-Modified和Content-Length转为16进制后再拼接而成，是加强版的Last-Modified。</p> <p><strong>提问，如果响应头的Etag变了，文件内容就一定变了吗？</strong><br>
不一定。因为Etag中包含Last-Modified,Last-Modified由mtime组成，当编辑文件但没修改内容时，mtime也会改变，造成Etag也改变。
mtime: modified time 文件内容改变的事件戳。</p> <h2 id="浏览器存储"><a href="#浏览器存储" class="header-anchor">#</a> 浏览器存储</h2> <table><thead><tr><th></th> <th>cookie</th> <th>localstorage</th> <th>sessionStorage</th></tr></thead> <tbody><tr><td>存储大小</td> <td>4Kb</td> <td>5Mb</td> <td>5Mb</td></tr> <tr><td>生命周期</td> <td>可设置失效事件，默认是关闭浏览器后失效</td> <td>若用户不清除，则永远存在</td> <td>当前会话有效，关闭页面或浏览器清除</td></tr> <tr><td>与服务端通信</td> <td>每次都会携带在http头中，如果cookie保存过多数据会影响性能</td> <td>仅在客户端保存</td> <td>仅在客户端保存</td></tr> <tr><td>易用性</td> <td>需要封装，原生接口不友好</td> <td>原生接口可以接受，也可自己再封装</td> <td>同左</td></tr></tbody></table> <h3 id="cookie"><a href="#cookie" class="header-anchor">#</a> cookie</h3> <p>服务端发送给客户端并保存在本地的一段数据，用于记录用户数据，验证用户身份，cookie是不能跨域的，客户端每次发送http请求都会携带cookie来验明身份。<br> <strong>cookie设置</strong></p> <ol><li>服务端设置，响应头的set-cookie字段可生成cookie信息保存在客户端</li> <li>客户端设置<br>
字段：name(cookie名称)，value(值)，domain(域名), path(页面路径)，expires/Max-Age(超时时间，设置一个时间，到达时间后失效，如果不设置则默认值为session,当浏览器关闭后失效)，size(cookie大小)，http(httponly属性，若为true，则不能通过document.cookie来访问cookie),secure(设置是否只能通过https来传递cookie)</li></ol> <div class="language-js extra-class"><pre class="language-js"><code>document<span class="token punctuation">.</span>cookie <span class="token operator">=</span> <span class="token string">'key = value'</span><span class="token comment">//js中设置cookie</span>

<span class="token keyword">var</span> time <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token operator">+</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">120</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
document<span class="token punctuation">.</span>cookie <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">name = xxx;expires = $(time.toGMTString())</span><span class="token template-punctuation string">`</span></span><span class="token comment">//设置cookie过期时间expires,如果要删除cookie，就设置过去的时间</span>

<span class="token comment">/*原则上cookie不能跨域，如果想实现跨域，就得设置域或者路径。domain 只有当cookie的domain和当前域名匹配时才能访问到cookie,当网址不止一个域名时，比如a.example.com和b.example.com如果想共享cookie,那么domain要设置成example.com，path路径要设置为/ */</span>

<span class="token keyword">var</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span> <span class="token operator">+</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">120</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
document<span class="token punctuation">.</span>cookie <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">name=monsterooo;expires=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>t<span class="token punctuation">.</span><span class="token function">toLocaleTimeString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">; domain=.example.com; path=/</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
</code></pre></div><p>扩展：<br>
浏览器的cookie新增了SameSite属性，用来防止CSRF攻击和用户追踪，限制第三方的cookie.
SameSite属性有3个值：</p> <ul><li>Strict. 完全禁止第三方cookie.只有当前网页的URL与请求目标一致时才带cookie,网页跳转时不会携带cookie,也就不会记录用户状态。</li> <li>Lax。链接，预加载请求，get表单会发送cookie,其他情况不发送第三方cookie;</li> <li>None</li></ul> <p>谷歌默认为Lax.
Strict和Lax基本能杜绝CSRF攻击（需用户浏览器支持SameSite,浏览器&gt;=chrome51）</p> <p>解决：<br>
1.设置代理
2.用火狐浏览器调试；
3.谷歌浏览器关闭SameSite属性，改为none,前提是必须同时设置Secure属性（Cookie 只能通过 HTTPS 协议发送），否则无效。</p> <p>ps:考虑到安全，应该使用session或token.<br> <strong>session</strong>:记录用户的会话，存储在服务端，根据session id来确认用户身份。但是当访问增多时会占用服务器性能，session用户在20分钟内没操作的话就会删除。但是使用session也需要依赖cookie，sessionId会存储在cookie中，如果cookie被禁用，则会将sessionId写在URL中。</p> <h3 id="localstorage-和-sessionstorage"><a href="#localstorage-和-sessionstorage" class="header-anchor">#</a> localStorage 和 sessionStorage</h3> <p>两者提供了统一的API来访问和设置数据：</p> <ol><li>clear。清除所有存储数据</li> <li>getItem。接收参数key,获取key对应的键值对</li> <li>removeItem。接收参数key,删除key对应的键值对</li> <li>setItem。接收key和value,如果不存在key则添加，存在就更新</li> <li>key。接收整数索引，返回对应下标的键值对的key</li></ol> <div class="language-js extra-class"><pre class="language-js"><code>localStorage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span><span class="token string">'order'</span><span class="token punctuation">,</span> <span class="token string">'123'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>localStorage<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//order</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>localStorage<span class="token punctuation">.</span><span class="token function">getItem</span><span class="token punctuation">(</span><span class="token string">'order'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//123</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>localStorage<span class="token punctuation">.</span>order<span class="token punctuation">)</span> <span class="token comment">//123</span>
localStorage<span class="token punctuation">.</span><span class="token function">removeItem</span><span class="token punctuation">(</span><span class="token string">'order'</span><span class="token punctuation">)</span>
localStorage<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre></div><h3 id="indexeddb"><a href="#indexeddb" class="header-anchor">#</a> IndexedDB</h3> <p>IndexedDB是浏览器提供的本地数据库。相比与上述的存储方式，它的优势在于：</p> <ol><li>存储空间更大。一般不少于250MB。</li> <li>异步。异步是为了防止大量数据的读写，拖慢网页的表现，而localStorage的话是同步操作的。</li> <li>支持二进制存储。IndexedDB不仅支持字符串存储，还支持存储二进制数据，而localStorage只支持字符串存储</li></ol></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">11/2/2020, 4:17:53 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/browser/crossDomain.html" class="prev">
        跨域
      </a></span> <span class="next"><a href="/browser/render.html">
        浏览器渲染
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.bd3a774d.js" defer></script><script src="/assets/js/2.591daaf2.js" defer></script><script src="/assets/js/13.568dcd97.js" defer></script>
  </body>
</html>
